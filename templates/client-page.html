<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Проверка пароля</title>
<link rel="icon" href="https://cdn4.iconfinder.com/data/icons/web-ui-color/128/Lock-512.png" type="image/png">
<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<style type="text/css">
    .page-neutral {
        --color-text: #002C60;
        --color-background: #64BBFF;
        --color-input-background: #F3FAFF;
        --color-input-outline-hover: #2F94D5;
        --color-input-outline-focus: #006FAC;
        --color-block-background: #D4F4FF;
    }
    .page-success {
        --color-text: #003912;
        --color-background: #7FF9C1;
        --color-input-background: #EFFCF5;
        --color-input-outline-hover: #48C591;
        --color-input-outline-focus: #009463;
        --color-block-background: #CEFBE3;
    }
    .page-warning {
        --color-text: #580000;
        --color-background: #FF8D69;
        --color-input-background: #FFF7F3;
        --color-input-outline-hover: #D46847;
        --color-input-outline-focus: #A94426;
        --color-block-background: #FFE6D7;
    }

    body {
        text-align: center;
        margin: 0px;
        font-family: 'Montserrat', sans-serif;
        font-weight: bold;
        color: var(--color-text);
        background-color: var(--color-background);
        transition: all 0.5s ease;
    }

    .inline-input {
        text-align: center;
        width: 100%;
        padding: 0px 10px;
        border: none;
        outline: none;
        font-weight: bold;
        color: var(--color-text);
        background-color: var(--color-input-background);
        opacity: 0.8;
    }
    .inline-input::placeholder {
        color: var(--color-text);
        opacity: 0.6;
    }
    .inline-input:focus::placeholder {
        color: transparent;
    }

    .input-bar {
        display: flex;
        margin-left: 25%;
        margin-right: 25%;
        padding: 10px 15px;
        border-radius: 20px;
        background-color: var(--color-input-background);
    }
    .input-bar:hover {
        outline: 2px solid var(--color-input-outline-hover);
    }
    .input-bar:focus-within {
        outline: 2px solid var(--color-input-outline-focus);
    }

    .gap-5vh {
        height: 5vh;
    }
    .gap-10vh {
        height: 10vh;
    }
    .gap-20vh {
        height: 20vh;
    }

    .block-text {
        margin-left: 20%;
        margin-right: 20%;
        padding: 15px;
        border-radius: 20px;
        text-align: left;
        word-wrap: break-word;
        overflow-wrap: break-word;
        background-color: var(--color-block-background);
    }

    .page-warning .text-success {
        color: #00A86C;
    }

    #password-visibility-toggle {
        width: 30px;
        fill: var(--color-text);
        opacity: 0.6;
    }
    #password-visibility-toggle:hover {
        opacity: 0.8;
    }
</style>
</head>
<body class="page-neutral" align="center">

<div class="gap-10vh"></div>
<h1>Проверьте свой пароль</h1>
<div class="gap-5vh"></div>
<div class="input-bar">
    <input id="password-input" class="inline-input" type="password" placeholder="Введите пароль" maxlength="100" oninput="handlePasswordInput()">
    <svg id="password-visibility-toggle" version="1.1" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" onclick="togglePasswordVisibility()">
        <path d="M29.946,15.675C27.954,9.888,22.35,6,16,6S4.046,9.888,2.054,15.675c-0.072,0.21-0.072,0.44,0,0.65  C4.046,22.112,9.65,26,16,26s11.954-3.888,13.946-9.675C30.018,16.115,30.018,15.885,29.946,15.675z M16,22c-3.309,0-6-2.691-6-6  s2.691-6,6-6s6,2.691,6,6S19.309,22,16,22z"/>
    </svg>
</div>
<div class="gap-10vh"></div>
<div id="block-result" class="block-text" hidden></div>
<div class="gap-20vh"></div>

<script>
const toggleShowPasswordSvgContent = '<path d="M29.946,15.675C27.954,9.888,22.35,6,16,6S4.046,9.888,2.054,15.675c-0.072,0.21-0.072,0.44,0,0.65  C4.046,22.112,9.65,26,16,26s11.954-3.888,13.946-9.675C30.018,16.115,30.018,15.885,29.946,15.675z M16,22c-3.309,0-6-2.691-6-6  s2.691-6,6-6s6,2.691,6,6S19.309,22,16,22z"/>';
const toggleHidePasswordSvgContent = '<path d="M20.722,24.964c0.096,0.096,0.057,0.264-0.073,0.306c-7.7,2.466-16.032-1.503-18.594-8.942  c-0.072-0.21-0.072-0.444,0-0.655c0.743-2.157,1.99-4.047,3.588-5.573c0.061-0.058,0.158-0.056,0.217,0.003l4.302,4.302  c0.03,0.03,0.041,0.072,0.031,0.113c-1.116,4.345,2.948,8.395,7.276,7.294c0.049-0.013,0.095-0.004,0.131,0.032  C17.958,22.201,20.045,24.287,20.722,24.964z"/><path d="M24.68,23.266c2.406-1.692,4.281-4.079,5.266-6.941c0.072-0.21,0.072-0.44,0-0.65  C27.954,9.888,22.35,6,16,6c-2.479,0-4.841,0.597-6.921,1.665L3.707,2.293c-0.391-0.391-1.023-0.391-1.414,0s-0.391,1.023,0,1.414  l26,26c0.391,0.391,1.023,0.391,1.414,0c0.391-0.391,0.391-1.023,0-1.414L24.68,23.266z M16,10c3.309,0,6,2.691,6,6  c0,1.294-0.416,2.49-1.115,3.471l-8.356-8.356C13.51,10.416,14.706,10,16,10z"/>';
const passwordCheckDelay = 240;
const indicationNeutral = 'neutral';
const indicationSuccess = 'success';
const indicationWarning = 'warning';
const recommendedMinLength = 8;
const recommendedMinDifferentSymbols = 5;
const criticalLeakThreshold = 5;
const apiBaseUri = '/range/';

function setPageIndication(indication) {
    document.body.className = `page-${indication}`;
}

function togglePasswordVisibility() {
    const input = document.getElementById('password-input');
    const visibilityToggle = document.getElementById('password-visibility-toggle');
    if (input.type === 'password') {
        input.type = 'text';
        visibilityToggle.innerHTML = toggleHidePasswordSvgContent;
    } else {
        input.type = 'password';
        visibilityToggle.innerHTML = toggleShowPasswordSvgContent;
    }
}

function getResultBlock() {
    return document.getElementById('block-result');
}

function getCurrentPassword() {
    return document.getElementById('password-input').value;
}

function isTooShort(password) {
    return password.length < recommendedMinLength;
}

function isDiverse(password) {
    return recommendedMinDifferentSymbols <= new Set(password).size;
}

function hasOnlyDigits(password) {
    return /^\d+$/.test(password);
}

function hasOnlyLowercaseLetters(password) {
    return /^[a-z]+$/.test(password);
}

function hasOnlyUppercaseLetters(password) {
    return /^[A-Z]+$/.test(password);
}

function showResult(password, leakOccasionNumber) {
    let resultContent = '';
    const isNotLeaked = leakOccasionNumber === 0;
    if (leakOccasionNumber === null) {
        resultContent += '<p>Ошибка: Не удалось проверить пароль на утечки</p>';
    } else {
        if (leakOccasionNumber === 0) {
            resultContent += '<p class="text-success">Утечек не обнаружено</p>';
        } else if (leakOccasionNumber < criticalLeakThreshold) {
            resultContent += '<p>Обнаружено несколько утечек</p>';
        } else {
            resultContent += '<p>Обнаружено множество утечек</p>';
        }
    }
    let isWeak = false;
    if (isTooShort(password)) {
        isWeak = true;
        resultContent += `<p>Пароль должен иметь длину не менее ${recommendedMinLength} символов</p>`;
    } else {
        if (!isDiverse(password)) {
            isWeak = true;
            resultContent += `<p>Пароль должен включать не менее ${recommendedMinDifferentSymbols} различных символов</p>`;
        } else {
            if (hasOnlyDigits(password)) {
                isWeak = true;
                resultContent += `<p>Пароль не должен состоять только из цифр</p>`;
            }
            if (hasOnlyLowercaseLetters(password)) {
                isWeak = true;
                resultContent += `<p>Пароль не должен состоять только из строчных латинских букв</p>`;
            }
            if (hasOnlyUppercaseLetters(password)) {
                isWeak = true;
                resultContent += `<p>Пароль не должен состоять только из прописных латинских букв</p>`;
            }
        }
    }
    getResultBlock().innerHTML = resultContent;
    getResultBlock().removeAttribute('hidden');
    setPageIndication(!isNotLeaked || isWeak ? indicationWarning : indicationSuccess);
}

function countLeakOccasions(leakRecords, hashSuffix) {
    const lines = leakRecords.split(/\r?\n/);
    for (const line of lines) {
        const [suffix, occasionCount] = line.split(':');
        if (suffix === hashSuffix) {
            return parseInt(occasionCount, 10) || null;
        }
    }
    return 0;
}

async function checkPasswordIfNotUpdated(password) {
    if (password !== getCurrentPassword()) {
        return;
    }
    const passwordHash = CryptoJS.SHA1(password).toString(CryptoJS.enc.Hex).toUpperCase();
    const hashPrefix = passwordHash.slice(0, 5);
    const hashSuffix = passwordHash.slice(5);
    await $.ajax({
        url: apiBaseUri + hashPrefix,
        method: 'GET',
        success: function (data) {
            showResult(password, countLeakOccasions(data, hashSuffix));
        },
        error: function () {
            showResult(password, null);
        }
    });
}

function handlePasswordInput() {
    const currentPassword = getCurrentPassword();
    if (currentPassword === '') {
        setPageIndication(indicationNeutral);
        getResultBlock().innerHTML = '';
        getResultBlock().setAttribute('hidden', 'true');
        return;
    }
    setTimeout(() => {
        checkPasswordIfNotUpdated(currentPassword);
    }, passwordCheckDelay);
}
</script>
</body>
</html>
